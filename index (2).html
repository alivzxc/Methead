<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Metheads ‚Äì Bury Line (Yellow)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#020617;
      --card:#0b1220;
      --card2:#0a1020;
      --text:#f9fafb;
      --muted:#9ca3af;

      --accent:#ffd500;
      --accent2:#ffea7a;

      --border: rgba(148,163,184,.55);
      --border2: rgba(56,189,248,.45);

      --danger:#fb7185;
      --success:#4ade80;

      --shadow: 0 22px 60px rgba(15, 23, 42, 0.9);
      --r-xl: 1.5rem;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      color:var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:stretch;
      padding:16px;
    }

    .shell{
      width:100%;
      max-width: 1480px;
      border-radius: 1.75rem;
      background:
        radial-gradient(circle at top left, rgba(251,191,36,.28), transparent 52%),
        radial-gradient(circle at bottom right, rgba(56,189,248,.24), transparent 60%),
        linear-gradient(145deg, #020617, #020617 40%, #020617 100%);
      box-shadow: var(--shadow);
      padding:18px;
      display:grid;
      grid-template-rows: auto 1fr;
      gap:16px;
      min-height: calc(100vh - 32px);
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .brand{ display:flex; gap:12px; align-items:center; }

    .logo{
      width:42px;height:32px;border-radius:999px;
      background: radial-gradient(circle at 25% 0%, #fff, #ffd500 50%, #b45309);
      box-shadow: 0 0 0 1px rgba(15,23,42,.7), 0 12px 26px rgba(15,23,42,.95);
      position:relative;
    }
    .logo::before,.logo::after{
      content:""; position:absolute; left:15%; width:70%; height:3px;
      border-radius:999px; background: rgba(15,23,42,.9);
    }
    .logo::before{ top:8px; }
    .logo::after{ bottom:8px; }

    .brand-main h1{
      margin:0;
      font-size:1.25rem;
      letter-spacing:.04em;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .tag{
      font-size:.68rem;
      text-transform:uppercase;
      padding:2px 8px;
      border-radius:999px;
      background: rgba(234,179,8,.16);
      border:1px solid rgba(250,204,21,.8);
      color:#fef3c7;
      white-space:nowrap;
    }
    .brand-main p{
      margin:2px 0 0;
      font-size:.78rem;
      color:var(--muted);
    }

    .summary{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-size:.8rem;
    }
    .chip{
      padding:7px 11px;
      border-radius:999px;
      background: rgba(15,23,42,.85);
      border:1px solid var(--border);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .chip .value{
      font-weight:700;
      color: var(--accent2);
    }

    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.65);
      background: rgba(15,23,42,.9);
      color:#e5e7eb;
      font-size:.78rem;
      padding:7px 12px;
      cursor:pointer;
      transition:150ms ease-out;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 30px rgba(15,23,42,.8);
      border-color: rgba(248,250,252,.4);
    }
    .btn.donate{
      border-color: rgba(250,204,21,.85);
      background: rgba(250,204,21,.12);
      color: #fff7cc;
    }
    .btn.donate:hover{
      background: rgba(250,204,21,.18);
      box-shadow: 0 0 0 1px rgba(250,204,21,.45), 0 12px 30px rgba(15,23,42,.85);
    }

    /* ====== MAIN GRID (3 columns) ====== */
    main{
      display:grid;
      grid-template-columns: minmax(0, 4.6fr) minmax(0, 5.4fr) minmax(0, 4fr);
      gap:18px;
      min-height:0; /* CRITICAL for scrolling children */
    }

    @media (max-width: 1100px){
      main{ grid-template-columns: minmax(0, 1fr); }
    }

    /* left stack (map + google maps) */
    .left-stack{
      display:grid;
      grid-template-rows: auto auto;
      gap:10px;            /* CHANGED: pull Google Maps up */
      min-height:0;
      align-content:start; /* CHANGED: stops that dead space under map */
    }

    .card{
      border-radius: var(--r-xl);
      border:1px solid var(--border);
      background:
        radial-gradient(circle at top, rgba(148,163,184,.14), transparent 55%),
        radial-gradient(circle at bottom, rgba(15,23,42,.9), transparent 60%),
        rgba(2,6,23,.6);
      overflow:hidden;
    }

    /* Map card */
    .map-card{
      padding:14px 14px 16px;
      /* CHANGED: removed min-height to remove unnecessary space */
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .map-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
    .map-head h2{
      margin:0;
      font-size:.98rem;
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    .map-head p{
      margin:2px 0 0;
      font-size:.78rem;
      color:var(--muted);
      max-width: 60ch;
    }

    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-size:.72rem;
      color:var(--muted);
    }
    .legend-item{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:3px 7px;
      border-radius:999px;
      background: rgba(15,23,42,.85);
      border:1px solid rgba(148,163,184,.5);
    }
    .colour-dot{ width:14px; height:4px; border-radius:999px; background: var(--accent); }
    .zone1{ background:#f97316; }
    .zone2{ background:#22c55e; }
    .zone3{ background:#3b82f6; }
    .zone4{ background:#a855f7; }

    .canvas-wrap{
      border-radius: 1.1rem;
      border:1px solid rgba(148,163,184,.45);
      overflow:hidden;
      position:relative;
      background:
        radial-gradient(circle at top, rgba(30,64,175,.32), transparent 55%),
        radial-gradient(circle at bottom, rgba(22,163,74,.32), transparent 60%),
        #020617;
    }
    #mapCanvas{ width:100%; height:340px; display:block; }
    .zone-rings-label{
      position:absolute;
      right:10px; bottom:7px;
      padding:3px 8px;
      border-radius:999px;
      background: rgba(15,23,42,.95);
      font-size:.7rem;
      color: var(--muted);
      border:1px solid rgba(148,163,184,.5);
    }

    /* Google maps card */
    .live-card{
      padding:12px 12px 14px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .live-card h2{
      margin:0;
      font-size:.9rem;
      letter-spacing:.12em;
      text-transform:uppercase;
    }
    .live-card p{
      margin:2px 0 4px;
      font-size:.76rem;
      color:var(--muted);
    }
    .live-frame-wrap{
      min-height: 210px;
      border-radius: 1rem;
      overflow:hidden;
      border:1px solid rgba(148,163,184,.7);
      background: rgba(15,23,42,.96);
    }
    .live-frame-wrap iframe{ width:100%; height:100%; border:0; }
    .live-note{ font-size:.7rem; color:var(--muted); }

    /* Stations card (middle) */
    .stations-card{
      border-radius: var(--r-xl);
      border:1px solid var(--border2);
      background: linear-gradient(135deg, rgba(15,23,42,.96), rgba(15,23,42,.9));
      padding:14px 14px 16px;
      position:relative;
      overflow:hidden;

      display:flex;
      flex-direction:column;
      min-height:0; /* important */
    }
    .stations-card::before{
      content:"";
      position:absolute;
      inset:-40%;
      opacity:.14;
      background:
        radial-gradient(circle at 15% 20%, rgba(251,191,36,1), transparent 60%),
        radial-gradient(circle at 80% 90%, rgba(56,189,248,1), transparent 60%);
      pointer-events:none;
      mix-blend-mode:screen;
    }
    .stations-inner{ position:relative; z-index:1; display:flex; flex-direction:column; min-height:0; }

    .stations-header{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:6px;
    }
    .stations-header h2{
      margin:0;
      font-size:.9rem;
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    .mode-badge{
      padding:3px 9px;
      border-radius:999px;
      font-size:.7rem;
      border:1px solid rgba(56,189,248,.7);
      background: rgba(8,47,73,.9);
      color:#e0f2fe;
      white-space:nowrap;
    }
    .sub{
      margin:0 0 8px;
      font-size:.78rem;
      color:#d1d5db;
    }
    .sub span{ color: var(--accent2); font-weight:700; }

    .current-status{
      margin-bottom:10px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.5);
      font-size:.74rem;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .current-status .highlight{ color:var(--accent2); font-weight:700; }

    /* Scrollable panels */
    .panels{
      display:grid;
      grid-template-rows: minmax(0, 1.1fr) minmax(0, .9fr);
      gap:10px;
      min-height:0; /* important */
      flex:1;
    }

    .stations{
      border-radius: 1.1rem;
      background: rgba(15,23,42,.95);
      border:1px solid rgba(148,163,184,.5);
      padding:6px 8px 8px;
      overflow:auto;
      min-height:0;
    }
    .alerts{
      border-radius: 1.1rem;
      background: rgba(15,23,42,.97);
      border:1px solid rgba(148,163,184,.6);
      padding:6px 8px 8px;
      overflow:auto;
      min-height:0;
      font-size:.72rem;
    }
    .stations::-webkit-scrollbar,
    .alerts::-webkit-scrollbar{ width:6px; }
    .stations::-webkit-scrollbar-track,
    .alerts::-webkit-scrollbar-track{ background: rgba(15,23,42,.7); }
    .stations::-webkit-scrollbar-thumb,
    .alerts::-webkit-scrollbar-thumb{ background: rgba(148,163,184,.85); border-radius:999px; }

    .station-row{
      padding:5px 6px 6px;
      border-radius:.75rem;
      display:grid;
      grid-template-columns: minmax(0,1.2fr) minmax(0,2.8fr);
      gap:10px;
      align-items:center;
      margin-bottom:4px;
      cursor:pointer;
      transition:130ms ease-out;
    }
    .station-row:hover{ background: rgba(15,23,42,1); transform: translateY(-.5px); }
    .station-row.active{
      background: rgba(248,250,252,.04);
      box-shadow: 0 0 0 1px rgba(248,250,252,.1);
    }
    .st-main{ display:flex; flex-direction:column; gap:1px; }
    .st-name{ font-size:.8rem; }
    .st-meta{ font-size:.66rem; color:var(--muted); }

    .st-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
    }
    .btn-report{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background: rgba(15,23,42,.95);
      font-size:.7rem;
      padding:6px 10px;
      color:#e5e7eb;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      white-space:nowrap;
      transition:130ms ease-out;
      flex: 1 1 calc(50% - 8px);
      min-width: 160px;
    }
    .btn-report:hover{
      background: rgba(251,191,36,.12);
      border-color: var(--accent2);
      color: var(--accent2);
      box-shadow: 0 0 0 1px rgba(251,191,36,.35);
    }
    .btn-report.bad{
      border-color: rgba(248,113,113,.9);
      background: rgba(185,28,28,.18);
      color:#fecaca;
    }
    .btn-report.good{
      border-color: rgba(34,197,94,.9);
      background: rgba(22,163,74,.18);
      color:#bbf7d0;
    }

    .alerts-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
      color:var(--muted);
      gap:8px;
      flex-wrap:wrap;
    }
    .summary-counts{ font-size:.68rem; color:var(--muted); }
    .summary-counts span{ font-weight:700; color: var(--accent2); }

    .alert-row{
      padding:4px 6px;
      border-radius:.6rem;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
      margin-bottom:2px;
    }
    .alert-row:nth-child(odd){ background: rgba(17,24,39,.85); }
    .alert-main{ display:flex; flex-direction:column; gap:1px; }
    .alert-main .name{ font-size:.76rem; }
    .time{ color:var(--muted); font-size:.68rem; white-space:nowrap; }

    .badge-a,.badge-b{
      padding:1px 7px;
      border-radius:999px;
      border:1px solid;
      font-size:.68rem;
      white-space:nowrap;
    }
    .badge-a{
      border-color: rgba(249,115,22,.9);
      background: rgba(248,113,22,.16);
      color:#fed7aa;
    }
    .badge-b{
      border-color: rgba(34,197,94,.9);
      background: rgba(34,197,94,.18);
      color:#bbf7d0;
    }

    /* Analytics (right) */
    .analytics-card{
      border-radius: var(--r-xl);
      border:1px solid rgba(148,163,184,.6);
      background:
        radial-gradient(circle at top, rgba(148,163,184,.16), transparent 55%),
        linear-gradient(135deg, rgba(15,23,42,.98), rgba(15,23,42,.94));
      padding:14px 14px 16px;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .analytics-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:6px;
    }
    .analytics-header h2{
      margin:0;
      font-size:.9rem;
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    .analytics-tag{
      padding:3px 9px;
      border-radius:999px;
      font-size:.7rem;
      border:1px solid rgba(148,163,184,.8);
      background: rgba(15,23,42,.9);
      color: var(--muted);
      white-space:nowrap;
    }
    .analytics-sub{
      margin:0 0 10px;
      font-size:.76rem;
      color: var(--muted);
    }

    .analytics-summary{
      border-radius: 1.1rem;
      border:1px solid rgba(148,163,184,.6);
      background: rgba(15,23,42,.96);
      padding:10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-bottom:10px;
    }
    .metric-main{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
    }
    .metric-label{ font-size:.75rem; color:var(--muted); }
    .metric-value{ font-size:1.3rem; font-weight:800; color: var(--accent2); }

    .metric-split{ display:flex; flex-direction:column; gap:6px; font-size:.72rem; }
    .metric-row{ display:flex; justify-content:space-between; align-items:baseline; color:#e5e7eb; }
    .metric-bar{
      height:6px;
      border-radius:999px;
      background: rgba(31,41,55,.9);
      overflow:hidden;
    }
    .metric-bar-fill{
      height:100%;
      width:0%;
      border-radius:999px;
      transition: width 220ms ease-out;
    }
    .metric-bar-fill.bad{ background: rgba(248,113,113,.8); }
    .metric-bar-fill.good{ background: rgba(34,197,94,.8); }

    .analytics-stations{
      border-radius: 1.1rem;
      border:1px solid rgba(148,163,184,.6);
      background: rgba(15,23,42,.98);
      padding:8px 10px 10px;
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .analytics-stations-head{
      font-size:.74rem;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .analytics-stations-list{
      flex:1;
      min-height:0;
      overflow:auto;
      padding-top:2px;
    }
    .analytics-stations-list::-webkit-scrollbar{ width:6px; }
    .analytics-stations-list::-webkit-scrollbar-thumb{ background: rgba(148,163,184,.85); border-radius:999px; }

    .analytics-empty{
      font-size:.72rem;
      color:var(--muted);
      margin:0;
    }
    .analytics-station-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:5px 0;
      border-bottom: 1px dashed rgba(148,163,184,.22);
      font-size:.72rem;
    }
    .analytics-station-row:last-child{ border-bottom:none; }
    .analytics-station-main{ display:flex; flex-direction:column; gap:1px; }
    .analytics-station-name{ color:#e5e7eb; }
    .analytics-station-meta{ color:var(--muted); font-size:.68rem; }
    .analytics-station-counts{ text-align:right; color:var(--muted); font-weight:700; }
  </style>
</head>

<body>
  <div class="shell">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div class="brand-main">
          <h1>Metheads <span class="tag">Bury Line ‚Äì Yellow</span></h1>
          <p>Piccadilly ‚áÑ Bury with a tiny animated Metrolink carriage and station inspector reports.</p>
        </div>
      </div>

      <div class="summary">
        <div class="chip">Reports: <span class="value" id="reportCount">0</span></div>
        <div class="chip">Inspectors flagged: <span class="value" id="inspectorsCount">0</span></div>

        <a class="btn donate" href="https://buymeacoffee.com/metheads" target="_blank" rel="noopener">
          ‚òï Donate
        </a>
      </div>
    </header>

    <main>
      <!-- LEFT COLUMN: Map + Google Maps under it -->
      <div class="left-stack">
        <section class="card map-card">
          <div class="map-head">
            <div>
              <h2>Bury Line ‚Äì Approximate Metrolink Map Scale</h2>
              <p>Stations positioned to roughly match the official yellow line map (schematic, not GIS-accurate).</p>
            </div>
            <div class="legend">
              <div class="legend-item"><div class="colour-dot zone1"></div>Zone 1</div>
              <div class="legend-item"><div class="colour-dot zone2"></div>Zone 2</div>
              <div class="legend-item"><div class="colour-dot zone3"></div>Zone 3</div>
              <div class="legend-item"><div class="colour-dot zone4"></div>Zone 4</div>
            </div>
          </div>

          <div class="canvas-wrap">
            <canvas id="mapCanvas"></canvas>
            <div class="zone-rings-label">Not to scale for distance ‚Äì schematic only üêù</div>
          </div>
        </section>

        <section class="card live-card">
          <h2>Google Maps ‚Äì Bury Line Journey</h2>
          <p>
            Embedded Google Maps route from <strong>Manchester Piccadilly</strong> to
            <strong>Bury Interchange</strong>. Open in full screen to explore the tram corridor.
          </p>
          <div class="live-frame-wrap">
            <iframe
              src="https://www.google.com/maps?f=d&source=s_d&saddr=Manchester+Piccadilly+Station&daddr=Bury+Interchange&output=embed"
              loading="lazy"
              allowfullscreen
              referrerpolicy="no-referrer-when-downgrade"
              title="Manchester Piccadilly to Bury Interchange on Google Maps">
            </iframe>
          </div>
          <p class="live-note">
            Route styling and stop details are controlled by Google Maps ‚Äì use the full-screen button to zoom in.
          </p>
        </section>
      </div>

      <!-- MIDDLE COLUMN: Stations & Reports -->
      <aside class="stations-card">
        <div class="stations-inner">
          <div class="stations-header">
            <h2>Stations &amp; Inspector Reports</h2>
            <div class="mode-badge">Ticket Inspectors ‚Ä¢ No Ticket Inspectors</div>
          </div>

          <p class="sub">
            When the tram reaches your stop, tap the station and choose <span>Ticket Inspectors</span>
            if you see them, or <span>No Ticket Inspectors</span> if it‚Äôs clear.
          </p>

          <div class="current-status" id="currentStatus">
            <span>Current tram stop: <span class="highlight" id="currentStopName">‚Äî</span></span>
            <span>Local view: <span id="currentStopMood">no reports yet</span></span>
          </div>

          <div class="panels">
            <div class="stations" id="stationsList"></div>

            <div class="alerts" id="alertsPanel">
              <div class="alerts-head">
                <span>Latest alerts (from server)</span>
                <span class="summary-counts">
                  Inspectors: <span id="countA">0</span> ‚Ä¢ Clear: <span id="countB">0</span>
                </span>
              </div>
              <div id="alertsBody"></div>
            </div>
          </div>
        </div>
      </aside>

      <!-- RIGHT COLUMN: Analytics -->
      <section class="analytics-card">
        <div class="analytics-header">
          <h2>Metheads analytics</h2>
          <span class="analytics-tag" id="analyticsMode">Live + Local</span>
        </div>
        <p class="analytics-sub">
          Quick breakdown of reports (and what the server returns).
        </p>

        <div class="analytics-summary">
          <div class="metric-main">
            <span class="metric-label">Total reports</span>
            <span class="metric-value" id="analyticsTotal">0</span>
          </div>

          <div class="metric-split">
            <div class="metric-row">
              <span>Ticket inspectors</span>
              <span id="analyticsInspectors">0</span>
            </div>
            <div class="metric-bar">
              <div class="metric-bar-fill bad" id="analyticsInspectorsBar"></div>
            </div>

            <div class="metric-row">
              <span>No ticket inspectors</span>
              <span id="analyticsClear">0</span>
            </div>
            <div class="metric-bar">
              <div class="metric-bar-fill good" id="analyticsClearBar"></div>
            </div>
          </div>
        </div>

        <div class="analytics-stations">
          <div class="analytics-stations-head">
            <span>Most reported stops (top 5)</span>
          </div>
          <div id="analyticsStationsList" class="analytics-stations-list">
            <p class="analytics-empty">No reports yet. Use the buttons on a stop to see stats here.</p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ==== BURY LINE STATIONS ‚Äì with slugs ====
    const stations = [
      { name: "Bury", slug: "bury", zone: 4, x: 0.92, y: 0.10 },
      { name: "Radcliffe", slug: "radcliffe", zone: 4, x: 0.84, y: 0.11 },
      { name: "Whitefield", slug: "whitefield", zone: 4, x: 0.76, y: 0.11 },
      { name: "Besses o' th' Barn", slug: "besses-o-th-barn", zone: 3, x: 0.68, y: 0.13 },
      { name: "Prestwich", slug: "prestwich", zone: 3, x: 0.60, y: 0.15 },
      { name: "Heaton Park", slug: "heaton-park", zone: 3, x: 0.52, y: 0.17 },
      { name: "Bowker Vale", slug: "bowker-vale", zone: 3, x: 0.44, y: 0.19 },
      { name: "Crumpsall", slug: "crumpsall", zone: 2, x: 0.36, y: 0.20 },
      { name: "Abraham Moss", slug: "abraham-moss", zone: 2, x: 0.28, y: 0.21 },
      { name: "Queens Road", slug: "queens-road", zone: 2, x: 0.24, y: 0.28 },
      { name: "Victoria", slug: "victoria", zone: 1, x: 0.30, y: 0.40 },
      { name: "Shudehill", slug: "shudehill", zone: 1, x: 0.36, y: 0.42 },
      { name: "Market Street", slug: "market-street", zone: 1, x: 0.42, y: 0.44 },
      { name: "St Peter's Square", slug: "st-peters-square", zone: 1, x: 0.51, y: 0.47 },
      { name: "Piccadilly Gardens", slug: "piccadilly-gardens", zone: 1, x: 0.47, y: 0.55 },
      { name: "Piccadilly", slug: "piccadilly", zone: 1, x: 0.45, y: 0.62 }
    ];

    // local counters (we rebuild from server responses)
    stations.forEach(s => { s.reportsA = 0; s.reportsB = 0; });

    // ==== DOM REFS ====
    const canvas = document.getElementById("mapCanvas");
    const ctx = canvas.getContext("2d");

    const stationsListEl = document.getElementById("stationsList");
    const alertsBodyEl = document.getElementById("alertsBody");

    const currentStopNameEl = document.getElementById("currentStopName");
    const currentStopMoodEl = document.getElementById("currentStopMood");

    const reportCountEl = document.getElementById("reportCount");
    const inspectorsCountEl = document.getElementById("inspectorsCount");
    const countAEl = document.getElementById("countA");
    const countBEl = document.getElementById("countB");

    // analytics
    const analyticsTotalEl = document.getElementById("analyticsTotal");
    const analyticsInspectorsEl = document.getElementById("analyticsInspectors");
    const analyticsClearEl = document.getElementById("analyticsClear");
    const analyticsInspectorsBarEl = document.getElementById("analyticsInspectorsBar");
    const analyticsClearBarEl = document.getElementById("analyticsClearBar");
    const analyticsStationsListEl = document.getElementById("analyticsStationsList");

    // Tram animation state
    let tramIndex = 0;
    let direction = -1;
    let tickTimer = null;

    // Alerts shown in UI (server + pending local)
    const alerts = [];
    const pending = []; // local optimistic entries until server includes them

    // ==== BACKEND ====
    async function sendReportToServer(station, choice) {
      const resp = await fetch("/.netlify/functions/report", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ stationSlug: station.slug, choice })
      });

      // If function fails, keep pending but don‚Äôt crash
      if (!resp.ok) throw new Error("Report failed: " + resp.status);
      return resp.json();
    }

    // Merge pending into server list so analytics doesn't flash back to 0
    function mergePendingIntoRows(rows) {
      const serverKey = new Set(
        rows.map(r => `${r.station_slug}|${r.choice}|${new Date(r.created_at).getTime()}`)
      );

      // keep only pending still not seen on server (max 20s old)
      const now = Date.now();
      const stillPending = [];
      for (const p of pending) {
        const key = `${p.station_slug}|${p.choice}|${p.created_at}`;
        const age = now - p.created_at;
        if (!serverKey.has(key) && age < 20000) stillPending.push(p);
      }
      pending.length = 0;
      pending.push(...stillPending);

      // Convert pending to row-like objects and add
      const merged = rows.slice();
      for (const p of pending) {
        merged.unshift({
          station_slug: p.station_slug,
          choice: p.choice,
          created_at: new Date(p.created_at).toISOString()
        });
      }

      // Keep only 40 newest
      merged.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
      return merged.slice(0, 40);
    }

    async function refreshSharedAlerts() {
      try {
        const resp = await fetch("/.netlify/functions/latest", { cache: "no-store" });
        const data = await resp.json();
        const rowsRaw = data.alerts || [];
        const rows = mergePendingIntoRows(rowsRaw);

        // reset local state, rebuild from rows
        alerts.length = 0;
        stations.forEach(s => { s.reportsA = 0; s.reportsB = 0; });

        for (const row of rows) {
          const idx = stations.findIndex(s => s.slug === row.station_slug);
          if (idx === -1) continue;

          const time = new Date(row.created_at);
          const choice = row.choice === "A" ? "A" : "B";

          alerts.push({ stationIndex: idx, choice, time });

          if (choice === "A") stations[idx].reportsA += 1;
          else stations[idx].reportsB += 1;
        }

        updateCounts();
        renderAlerts();
        updateAnalytics();
        updateCurrentMood(tramIndex);
      } catch (err) {
        console.error("Failed to load shared alerts", err);
      }
    }

    // ==== UI BUILD ====
    function buildStationsList() {
      stationsListEl.innerHTML = "";
      stations.forEach((station, index) => {
        const row = document.createElement("div");
        row.className = "station-row";
        row.dataset.index = index;

        const main = document.createElement("div");
        main.className = "st-main";

        const name = document.createElement("div");
        name.className = "st-name";
        name.textContent = station.name;

        const meta = document.createElement("div");
        meta.className = "st-meta";
        meta.textContent = `Zone ${station.zone} ‚Ä¢ Bury (yellow) line`;

        main.appendChild(name);
        main.appendChild(meta);

        const actions = document.createElement("div");
        actions.className = "st-actions";

        const btnA = document.createElement("button");
        btnA.className = "btn-report bad";
        btnA.textContent = "Ticket Inspectors";
        btnA.addEventListener("click", async (e) => {
          e.stopPropagation();
          await submitReport(index, "A");
        });

        const btnB = document.createElement("button");
        btnB.className = "btn-report good";
        btnB.textContent = "No Ticket Inspectors";
        btnB.addEventListener("click", async (e) => {
          e.stopPropagation();
          await submitReport(index, "B");
        });

        actions.appendChild(btnA);
        actions.appendChild(btnB);

        row.appendChild(main);
        row.appendChild(actions);

        row.addEventListener("click", () => {
          scrollToStation(index);
        });

        stationsListEl.appendChild(row);
      });
    }

    function scrollToStation(index) {
      const row = stationsListEl.querySelector(`.station-row[data-index="${index}"]`);
      if (!row) return;
      row.scrollIntoView({ block: "nearest", behavior: "smooth" });
      highlightActiveRow(index);
    }

    function highlightActiveRow(index) {
      const rows = stationsListEl.querySelectorAll(".station-row");
      rows.forEach((r) => {
        r.classList.toggle("active", parseInt(r.dataset.index, 10) === index);
      });
    }

    // Submit report: optimistic UI + pending merge so analytics doesn't snap back
    async function submitReport(stationIndex, choice) {
      const s = stations[stationIndex];
      const now = Date.now();

      // Add to pending and local UI immediately
      pending.unshift({ station_slug: s.slug, choice, created_at: now });

      alerts.unshift({ stationIndex, choice, time: new Date(now) });
      if (alerts.length > 40) alerts.pop();

      if (choice === "A") s.reportsA += 1;
      else s.reportsB += 1;

      updateCounts();
      renderAlerts();
      updateAnalytics();
      updateCurrentMood(tramIndex);

      // Send to backend
      try {
        await sendReportToServer(s, choice);
        // refresh to sync with server, but keep pending merge to prevent flicker
        refreshSharedAlerts();
      } catch (err) {
        console.error("Failed to send report to server", err);
      }
    }

    function updateCounts() {
      const totalReports = alerts.length;
      const totalA = alerts.filter(a => a.choice === "A").length;
      const totalB = totalReports - totalA;

      reportCountEl.textContent = totalReports;
      inspectorsCountEl.textContent = totalA;
      countAEl.textContent = totalA;
      countBEl.textContent = totalB;
    }

    function renderAlerts() {
      alertsBodyEl.innerHTML = "";
      if (!alerts.length) {
        const empty = document.createElement("div");
        empty.style.color = "#9ca3af";
        empty.style.fontSize = "0.72rem";
        empty.textContent = "No alerts yet. Use the buttons on a station to add one.";
        alertsBodyEl.appendChild(empty);
        return;
      }

      alerts.forEach((alert) => {
        const st = stations[alert.stationIndex];
        const row = document.createElement("div");
        row.className = "alert-row";

        const main = document.createElement("div");
        main.className = "alert-main";

        const name = document.createElement("span");
        name.className = "name";
        name.textContent = st.name;

        const meta = document.createElement("span");
        meta.style.color = "#9ca3af";
        meta.textContent = `Zone ${st.zone} ‚Ä¢ Bury line`;

        main.appendChild(name);
        main.appendChild(meta);

        const right = document.createElement("div");
        right.style.display = "flex";
        right.style.alignItems = "center";
        right.style.gap = "8px";

        const badge = document.createElement("span");
        badge.className = alert.choice === "A" ? "badge-a" : "badge-b";
        badge.textContent = alert.choice === "A" ? "Ticket Inspectors" : "No Ticket Inspectors";

        const time = document.createElement("span");
        time.className = "time";
        time.textContent = alert.time.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

        right.appendChild(badge);
        right.appendChild(time);

        row.appendChild(main);
        row.appendChild(right);
        alertsBodyEl.appendChild(row);
      });
    }

    function updateAnalytics() {
      const total = alerts.length;
      const totalA = alerts.filter(a => a.choice === "A").length;
      const totalB = total - totalA;

      analyticsTotalEl.textContent = total;
      analyticsInspectorsEl.textContent = totalA;
      analyticsClearEl.textContent = totalB;

      const max = Math.max(totalA, totalB, 1);
      analyticsInspectorsBarEl.style.width = `${(totalA / max) * 100}%`;
      analyticsClearBarEl.style.width = `${(totalB / max) * 100}%`;

      analyticsStationsListEl.innerHTML = "";
      if (!alerts.length) {
        const empty = document.createElement("p");
        empty.className = "analytics-empty";
        empty.textContent = "No reports yet. Use the buttons on a stop to see stats here.";
        analyticsStationsListEl.appendChild(empty);
        return;
      }

      const stationCounts = new Map();
      alerts.forEach(a => {
        const st = stations[a.stationIndex];
        const entry = stationCounts.get(st.name) || { a:0, b:0 };
        if (a.choice === "A") entry.a++;
        else entry.b++;
        stationCounts.set(st.name, entry);
      });

      const top = [...stationCounts.entries()]
        .sort((x,y) => (y[1].a+y[1].b) - (x[1].a+x[1].b))
        .slice(0,5);

      top.forEach(([name, c]) => {
        const row = document.createElement("div");
        row.className = "analytics-station-row";

        const main = document.createElement("div");
        main.className = "analytics-station-main";

        const title = document.createElement("span");
        title.className = "analytics-station-name";
        title.textContent = name;

        const meta = document.createElement("span");
        meta.className = "analytics-station-meta";
        meta.textContent = `Inspectors: ${c.a} ‚Ä¢ Clear: ${c.b}`;

        main.appendChild(title);
        main.appendChild(meta);

        const counts = document.createElement("div");
        counts.className = "analytics-station-counts";
        counts.textContent = c.a + c.b;

        row.appendChild(main);
        row.appendChild(counts);
        analyticsStationsListEl.appendChild(row);
      });
    }

    function updateCurrentMood(index) {
      const s = stations[index];
      const total = s.reportsA + s.reportsB;

      if (!total) {
        currentStopMoodEl.textContent = "no reports yet";
        return;
      }
      const ratio = s.reportsA / total;

      if (ratio > 0.6) currentStopMoodEl.textContent = "inspectors likely";
      else if (ratio > 0.3) currentStopMoodEl.textContent = "mixed ‚Äì keep an eye out";
      else currentStopMoodEl.textContent = "generally clear";
    }

    // ==== CANVAS ====
    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      drawFrame();
    }
    window.addEventListener("resize", resizeCanvas);

    function zoneColour(zone) {
      return zone === 1 ? "#f97316" :
             zone === 2 ? "#22c55e" :
             zone === 3 ? "#3b82f6" :
             zone === 4 ? "#a855f7" : "#e5e7eb";
    }

    function drawFrame() {
      const w = canvas.clientWidth;
      const h = canvas.clientHeight;
      ctx.clearRect(0, 0, w, h);

      const midIndex = Math.floor(stations.length / 2);
      const centerX = stations[midIndex].x * w;
      const centerY = stations[midIndex].y * h;
      const baseR = Math.min(w, h) * 0.2;

      ["rgba(15,23,42,0.55)", "rgba(15,23,42,0.42)", "rgba(15,23,42,0.3)"].forEach((col, i) => {
        const r = baseR * (1.2 + i * 0.7);
        ctx.beginPath();
        ctx.arc(centerX, centerY, r, 0, Math.PI * 2);
        ctx.fillStyle = col;
        ctx.fill();
        ctx.closePath();
      });

      // line path
      ctx.beginPath();
      stations.forEach((s, i) => {
        const x = s.x * w;
        const y = s.y * h;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.strokeStyle = "rgba(248, 250, 252, 0.5)";
      ctx.lineWidth = 4;
      ctx.lineCap = "round";
      ctx.stroke();
      ctx.closePath();

      // stations + labels
      stations.forEach((s, i) => {
        const x = s.x * w;
        const y = s.y * h;
        const isCurrent = i === tramIndex;

        ctx.beginPath();
        ctx.arc(x, y, isCurrent ? 6 : 4, 0, Math.PI * 2);
        ctx.fillStyle = "rgba(248, 250, 252, 0.95)";
        ctx.fill();
        ctx.closePath();

        ctx.beginPath();
        ctx.arc(x, y, isCurrent ? 9 : 7, 0, Math.PI * 2);
        ctx.strokeStyle = zoneColour(s.zone);
        ctx.lineWidth = isCurrent ? 2 : 1.5;
        ctx.stroke();
        ctx.closePath();

        if (isCurrent) {
          ctx.save();
          const label = s.name;
          ctx.font = "11px system-ui";
          const metrics = ctx.measureText(label);
          const paddingX = 7;
          const boxH = 18;
          const boxW = metrics.width + paddingX * 2;
          const labelX = x + 10;
          const labelY = y - 24;

          ctx.beginPath();
          if (ctx.roundRect) ctx.roundRect(labelX, labelY, boxW, boxH, 9);
          else ctx.rect(labelX, labelY, boxW, boxH);
          ctx.fillStyle = "rgba(15, 23, 42, 0.96)";
          ctx.strokeStyle = "rgba(15, 23, 42, 0.6)";
          ctx.lineWidth = 1;
          ctx.fill();
          ctx.stroke();
          ctx.closePath();

          ctx.fillStyle = "#e5e7eb";
          ctx.textAlign = "left";
          ctx.textBaseline = "middle";
          ctx.fillText(label, labelX + paddingX, labelY + boxH / 2);
          ctx.restore();
        }
      });

      // tram sprite
      const s = stations[tramIndex];
      const tx = s.x * w;
      const ty = s.y * h;
      const tramW = 34;
      const tramH = 14;

      ctx.save();
      ctx.translate(tx, ty + 18);

      ctx.beginPath();
      ctx.roundRect(-tramW / 2 - 2, -tramH / 2, tramW + 4, tramH, 7);
      ctx.fillStyle = "rgba(15, 23, 42, 0.85)";
      ctx.fill();
      ctx.closePath();

      const grad = ctx.createLinearGradient(-tramW / 2, 0, tramW / 2, 0);
      grad.addColorStop(0, "#fde047");
      grad.addColorStop(1, "#facc15");

      ctx.beginPath();
      ctx.roundRect(-tramW / 2, -tramH / 2, tramW, tramH, 7);
      ctx.fillStyle = grad;
      ctx.fill();
      ctx.closePath();

      ctx.fillStyle = "rgba(15, 23, 42, 0.96)";
      ctx.fillRect(-tramW / 2 + 4, -tramH / 2 + 3, tramW - 8, 6);

      ctx.fillStyle = "#e5e7eb";
      for (let i = 0; i < 3; i++) ctx.fillRect(-tramW / 2 + 5 + i * 9, -tramH / 2 + 4, 6, 4);

      ctx.beginPath();
      ctx.arc(-tramW / 2 + 7, tramH / 2, 3, 0, Math.PI * 2);
      ctx.arc(tramW / 2 - 7, tramH / 2, 3, 0, Math.PI * 2);
      ctx.fillStyle = "rgba(15, 23, 42, 0.96)";
      ctx.fill();
      ctx.closePath();

      ctx.restore();
    }

    function tick() {
      tramIndex += direction;
      if (tramIndex >= stations.length) { tramIndex = stations.length - 2; direction = -1; }
      else if (tramIndex < 0) { tramIndex = 1; direction = 1; }

      currentStopNameEl.textContent = stations[tramIndex].name;
      highlightActiveRow(tramIndex);
      updateCurrentMood(tramIndex);
      drawFrame();
    }

    function init() {
      buildStationsList();
      resizeCanvas();

      tramIndex = 0;
      direction = -1;
      currentStopNameEl.textContent = stations[tramIndex].name;
      highlightActiveRow(tramIndex);
      updateCurrentMood(tramIndex);

      if (tickTimer) clearInterval(tickTimer);
      tickTimer = setInterval(tick, 2200);

      // initial server load + polling
      refreshSharedAlerts();
      setInterval(refreshSharedAlerts, 7000);
    }

    init();
  </script>
</body>
</html>
